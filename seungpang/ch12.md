## 클라이언트 관리

### 클라이언트 핸들링

#### TCP 연결 vs UNIX 소켓
- Redis는 기본적으로 TCP 포트를 사용하지만 성능과 보안을 이유로 Unix 도메인 소켓 사용 가능
```conf
unixsocket /tmp/redis.sock
unixsocketperm 777
```
- `unixsocketperm 777`은 모든 사용자에게 소켓 접근을 허용함 → 보안 이슈 있음
- Redis는 **멀티플렉싱** 기반으로 하나의 스레드에서 여러 소켓을 감시하고 처리
    - **Non-blocking I/O** 방식으로 효율적인 동시 요청 처리 가능
    - `TCP_NODELAY`: 지연 없이 즉시 패킷 전송 (작은 패킷도 버퍼링 없이 전송)

### 클라이언트 버퍼 관리

#### 출력 버퍼
- Redis는 클라이언트 응답을 위한 **출력 버퍼(Output Buffer)**를 클라이언트별로 유지
- 클라이언트가 빠르게 읽지 않으면 출력 버퍼가 커지며 메모리 과다 사용 위험

#### 출력 버퍼 제한
- **하드 제한**: 즉시 연결 종료
- **소프트 제한**: 일정 시간(예: 60초) 이상 제한 초과 시 연결 종료
- 일반 클라이언트: 출력 버퍼 제한 거의 없음 (응답 후 다음 요청 전송)
- Pub/Sub 클라이언트:
    - 하드 제한: 32MB
    - 소프트 제한: 60초 동안 8MB 이상

#### 쿼리 버퍼
- 클라이언트로부터 받은 명령어를 Redis가 처리 전 임시로 저장하는 **내부 버퍼**
-  Q: 쿼리 버퍼는 성능 개선 목적? 백업/복구 목적?
    - → 주 목적은 **성능 개선**. 요청을 빠르게 받아들여 처리 대기열로 넘기기 위함

#### 클라이언트 이빅션

- Redis는 `maxmemory`를 넘지 않도록 **클라이언트 연결을 종료**할 수 있음
- Redis 7.0부터는 `maxmemory-clients` 옵션으로 **클라이언트가 사용하는 총 메모리**도 제한 가능
    - 초과 시 **가장 많은 메모리를 사용하는 클라이언트**부터 연결 해제
    - Q. 이 정책이 최선일까? 바꿀 수 있을까?
        - 정책 변경 불가 (현재 기준 Redis는 해당 우선순위 고정)
        - 모니터링 클라이언트 등 특정 연결은 이빅션 대상에서 제외 가능

#### Timeout과 TCP KeepAlive

- `timeout`: 클라이언트로부터 **응답이 없을 때 연결을 종료**하는 시간 (초 단위)
    - 기본값: `0` → 무제한 대기
    - ✅ 현실적으로는 `timeout` 설정하는 것이 장애 방지에 유리
- `tcp-keepalive`: 연결된 클라이언트에게 주기적으로 **TCP ACK 패킷 전송**
    - 클라이언트 응답 없을 시 연결 종료
    - 기본값: `300`초

### 파이프라이닝

- 여러 Redis 명령을 **한 번에 전송**하여 read/write 호출 수를 줄임
- 시스템 콜 오버헤드를 줄여 **레디스 응답 지연(Latency)** 개선

```text
요청1 -> read() -> 처리 -> write()
요청2 -> read() -> 처리 -> write()

파이프라이닝 시:
요청1, 요청2 -> read() 한 번에 -> 처리 -> write() 한 번에
```

- 예시: 1200만 키 중 100만 개 추출 → 배치 크기 5000 → 4시간 → 3분 (약 142배 성능 향상)
- 네트워크 대역폭 고려하여 batch size는 신중히 조정 필요

### 클라이언트 사이드 캐싱

- Redis 6부터 클라이언트 측 캐시 기능 도입 → **RTT 감소 및 응답 속도 향상**
- 클라이언트가 로컬에 캐싱하고 서버는 변경 시 invalidation 메시지 전송

#### 캐싱 모드
- **Default Mode**:
    - 클라이언트가 접근한 key 기억
    - 해당 key 변경 시 invalidation
    - 메모리 사용량 높음
- **Broadcasting Mode**:
    - 특정 prefix에 대해서만 클라이언트 등록
    - 메모리 사용 적고, CPU 사용은 다소 증가 가능
