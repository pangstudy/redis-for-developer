## 복제

### Redis 복제 구조 개요
- Redis는 MySQL, PostgreSQL과 달리 **멀티 마스터 구조를 지원하지 않음**
- 하나의 복제 그룹에는 항상 **단일 마스터 노드만 존재**
- 마스터 노드는 하나 이상의 복제본 노드를 가질 수 있음
- 복제본은 기본적으로 **읽기 전용**으로 동작하며 `replica-read-only` 옵션을 통해 쓰기도 가능하지만 데이터 유실 위험이 존재함

### 복제본 구성 방법
```bash
REPLICAOF <master-ip> <master-port>
```

### 복제 메커니즘

#### 버전 7 이전
- `repl-diskless-sync = no`
- 복제는 **디스크 I/O 속도에 영향**을 받음
    - 마스터가 RDB 파일 생성 → 디스크 저장
    - 복제본이 해당 파일을 디스크에서 읽어 메모리에 로드
- 복제 중 다른 복제 요청 발생 시 RDB 저장 완료 후 동시 복제 가능

#### 버전 7 이후
- `repl-diskless-sync = yes` (기본값)
- 디스크를 사용하지 않고 **소켓을 통해 직접 RDB 파일 전송**
    - 빠른 네트워크 환경에서 효과적
    - 복제본 노드는 파일의 유효성을 먼저 확인하지 못하므로 **기존 데이터를 삭제 전 보존 필요**
- 복제 중 다른 노드의 복제 요청은 **큐에 대기**해야 함 (소켓 방식이기 때문)

### 비동기 복제 연결
- 마스터 → 복제본 데이터 전달은 **비동기** 방식
- 데이터 유실 가능성은 낮지만, 비정상 종료 시 **부분 유실 가능**

#### 일치 여부 판단
- 각 노드는 `replication id`와 `offset`을 가짐
- `replication id + offset`이 정확히 일치하면 두 노드는 데이터 일치 상태

### 부분 재동기화
- 네트워크 불안정 시 전체 재복제를 피하기 위한 기능
- 마스터는 커맨드 로그를 **백로그 버퍼**에 저장함
- 복제본은 `PSYNC` 커맨드로 자신의 `replication id`와 `offset`을 마스터에 전달하여 **불일치 구간만 받아옴**
- 마스터는 기존 RDB 파일 없이 빠르게 복제 가능
- 복제본은 마스터 승격 가능성을 고려하여 백로그 버퍼 해제하지 않음

### Secondary 복제 ID
- 예: A → B, A → C 구조에서 A가 다운되면 B가 마스터로 승격
- B는 새로운 `replication id`를 갖고 C는 B에 연결되어 **새로운 복제 ID**를 공유함

### 복제본 노드의 읽기 전용 모드
- Redis 2.6 이후 복제본은 **기본적으로 읽기 전용**
- `replica-read-only no`로 쓰기 허용 가능하지만
    - 재시작이나 재복제 시 데이터 유실 가능성 높음
    - 복제 체인으로의 데이터 전달 불가
- 일반적으로 **로컬 테스트 용도**에만 제한적으로 사용

### 고가용성을 위한 구성 요소
#### 고가용성 정의
- 시스템이 **장애 없이 동작하는 시간의 비율**

#### Redis 고가용성 구성 요소
1. **복제**: 다수 복제본을 통한 장애 대비
2. **자동 장애조치(Failover)**: Sentinel 또는 Redis Cluster를 통해 마스터 장애 시 자동 전환

---

> 참고: Redis 복제는 단일 마스터-다중 복제본 구조로 명확한 데이터 흐름을 가짐. 쓰기 분산이 아닌, **읽기 분산**, **장애 대응**, **데이터 백업**의 용도로 사용됨.
